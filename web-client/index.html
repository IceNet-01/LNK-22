<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LNK-22 Mesh Network Control v1.9.0</title>
    <link rel="stylesheet" href="/src/style-enhanced.css?v=1.9.0">

    <!-- D3.js for network graph -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <h1>üõ∞Ô∏è LNK-22 Mesh Network</h1>
                    <div class="subtitle">Real-Time Mesh Monitoring & Control <span class="version-badge">v1.8.0</span></div>
                </div>
                <div class="header-actions">
                    <div class="connection-status">
                        <span id="statusIndicator" class="status-dot disconnected"></span>
                        <span id="statusText">Disconnected</span>
                    </div>
                    <button id="connectBtn" class="btn btn-primary">
                        <span class="btn-icon">üîå</span>
                        Connect Device
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <nav class="nav">
                    <button class="nav-item active" data-tab="dashboard">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-label">Dashboard</span>
                    </button>
                    <button class="nav-item" data-tab="network">
                        <span class="nav-icon">üåê</span>
                        <span class="nav-label">Network Graph</span>
                    </button>
                    <button class="nav-item" data-tab="routes">
                        <span class="nav-icon">üó∫Ô∏è</span>
                        <span class="nav-label">Routing Table</span>
                    </button>
                    <button class="nav-item" data-tab="messages">
                        <span class="nav-icon">üí¨</span>
                        <span class="nav-label">Messages</span>
                    </button>
                    <button class="nav-item" data-tab="map">
                        <span class="nav-icon">üìç</span>
                        <span class="nav-label">GPS Map</span>
                    </button>
                    <button class="nav-item" data-tab="console">
                        <span class="nav-icon">‚å®Ô∏è</span>
                        <span class="nav-label">Console</span>
                    </button>
                    <button class="nav-item" data-tab="settings">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span class="nav-label">Settings</span>
                    </button>
                </nav>

                <!-- Device Info Card -->
                <div class="device-card">
                    <div class="device-card-header">
                        <h3>Connected Device</h3>
                        <span id="deviceStatus" class="badge badge-gray">Offline</span>
                    </div>
                    <div class="device-info">
                        <div class="info-item">
                            <span class="label">Address</span>
                            <code id="deviceAddress" class="value">-</code>
                        </div>
                        <div class="info-item">
                            <span class="label">Uptime</span>
                            <span id="deviceUptime" class="value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Signal</span>
                            <div class="signal-bars">
                                <span id="deviceRSSI" class="value">- dBm</span>
                                <div id="signalStrength" class="signal-indicator"></div>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="label">SNR</span>
                            <span id="deviceSNR" class="value">- dB</span>
                        </div>
                    </div>
                    <div class="device-stats">
                        <div class="stat">
                            <div class="stat-value" id="neighborCount">0</div>
                            <div class="stat-label">Neighbors</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="routeCount">0</div>
                            <div class="stat-label">Routes</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Content Area -->
            <main class="content">
                <!-- Dashboard Tab -->
                <div id="dashboardTab" class="tab-content active">
                    <div class="tab-header">
                        <h2>Network Dashboard</h2>
                        <button id="refreshBtn" class="btn btn-secondary">
                            <span class="btn-icon">üîÑ</span>
                            Refresh
                        </button>
                    </div>

                    <!-- Stats Overview -->
                    <div class="stats-row">
                        <div class="stat-card stat-card-primary">
                            <div class="stat-card-icon">üì°</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="totalPackets">0</div>
                                <div class="stat-card-label">Total Packets</div>
                            </div>
                        </div>
                        <div class="stat-card stat-card-success">
                            <div class="stat-card-icon">üì§</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="packetsSent">0</div>
                                <div class="stat-card-label">Packets Sent</div>
                            </div>
                        </div>
                        <div class="stat-card stat-card-info">
                            <div class="stat-card-icon">üì•</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="packetsReceived">0</div>
                                <div class="stat-card-label">Packets Received</div>
                            </div>
                        </div>
                        <div class="stat-card stat-card-warning">
                            <div class="stat-card-icon">üîó</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="activeNeighbors">0</div>
                                <div class="stat-card-label">Neighbors</div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Features Stats (v1.5.0+) -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-card-icon">üîí</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="activeLinkCount">0</div>
                                <div class="stat-card-label">Secure Links</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">üë•</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="activeGroupCount">0</div>
                                <div class="stat-card-label">Groups</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">üì¶</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="sfQueueCount">0</div>
                                <div class="stat-card-label">Store & Forward</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon" id="sosStatusIcon">üÜò</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="sosStatusText">Ready</div>
                                <div class="stat-card-label">Emergency SOS</div>
                            </div>
                        </div>
                    </div>

                    <!-- Neighbor Status Grid -->
                    <div class="section">
                        <div class="section-header">
                            <h3>üì° Neighbor Status</h3>
                            <span id="lastUpdate" class="text-muted">Last updated: Never</span>
                        </div>
                        <div id="neighborsGrid" class="neighbors-grid">
                            <div class="empty-state">
                                <div class="empty-icon">üîç</div>
                                <p>No neighbors discovered yet</p>
                                <p class="text-muted">Waiting for beacon broadcasts...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Packet Activity Chart -->
                    <div class="section">
                        <div class="section-header">
                            <h3>üìà Packet Activity</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="packetChart"></canvas>
                        </div>
                    </div>

                    <!-- Signal Quality History -->
                    <div class="section">
                        <div class="section-header">
                            <h3>üìä Signal Quality</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="signalChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Network Graph Tab -->
                <div id="networkTab" class="tab-content">
                    <div class="tab-header">
                        <h2>Network Topology</h2>
                        <div class="graph-controls">
                            <button id="centerGraph" class="btn btn-secondary">Center</button>
                            <button id="freezeGraph" class="btn btn-secondary">Freeze</button>
                        </div>
                    </div>

                    <div class="graph-container">
                        <svg id="networkGraph"></svg>

                        <div class="graph-legend">
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #4CAF50"></span>
                                <span>This Node</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #2196F3"></span>
                                <span>Direct Neighbor</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #FF9800"></span>
                                <span>2+ Hops</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-line" style="background: #4CAF50; height: 3px"></span>
                                <span>Strong Signal</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-line" style="background: #FF5722; height: 2px"></span>
                                <span>Weak Signal</span>
                            </div>
                        </div>
                    </div>

                    <div class="graph-info">
                        <div class="info-card">
                            <h4>Graph Statistics</h4>
                            <div class="info-grid">
                                <div><strong>Total Nodes:</strong> <span id="graphNodeCount">0</span></div>
                                <div><strong>Total Links:</strong> <span id="graphLinkCount">0</span></div>
                                <div><strong>Network Diameter:</strong> <span id="graphDiameter">-</span></div>
                                <div><strong>Avg Hop Count:</strong> <span id="graphAvgHops">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Routes Tab -->
                <div id="routesTab" class="tab-content">
                    <div class="tab-header">
                        <h2>Routing Table</h2>
                        <button id="refreshRoutes" class="btn btn-secondary">Refresh</button>
                    </div>

                    <div class="routes-container">
                        <table class="table table-enhanced">
                            <thead>
                                <tr>
                                    <th>Destination</th>
                                    <th>Next Hop</th>
                                    <th>Hops</th>
                                    <th>Quality</th>
                                    <th>Age</th>
                                    <th>Path</th>
                                </tr>
                            </thead>
                            <tbody id="routesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="empty-state-inline">
                                            <span>üì≠</span> No routes in routing table
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="route-visual" id="routeVisual">
                            <h3>Route Visualization</h3>
                            <p class="text-muted">Select a route to see the path visualization</p>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab - Meshtastic-style layout -->
                <div id="messagesTab" class="tab-content">
                    <div class="chat-container">
                        <!-- Left Sidebar: Channels & DMs -->
                        <div class="chat-sidebar">
                            <div class="chat-sidebar-header">
                                <h3>Conversations</h3>
                                <button id="clearMessages" class="btn btn-icon" title="Clear All">üóëÔ∏è</button>
                            </div>

                            <!-- Channels Section -->
                            <div class="chat-section">
                                <div class="chat-section-title">Channels</div>
                                <div class="chat-list" id="channelList">
                                    <div class="chat-item active" data-chat="broadcast">
                                        <span class="chat-icon">üì¢</span>
                                        <div class="chat-info">
                                            <span class="chat-name">Broadcast</span>
                                            <span class="chat-preview">All nodes</span>
                                        </div>
                                        <span class="chat-unread" id="broadcastUnread" style="display:none">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Direct Messages Section -->
                            <div class="chat-section">
                                <div class="chat-section-title">Direct Messages</div>
                                <div class="chat-list" id="dmList">
                                    <!-- Populated dynamically from neighbors -->
                                    <div class="chat-empty">No neighbors discovered</div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Chat Area -->
                        <div class="chat-main">
                            <!-- Chat Header -->
                            <div class="chat-header">
                                <div class="chat-header-info">
                                    <span class="chat-header-icon">üì¢</span>
                                    <span class="chat-header-name" id="currentChatName">Broadcast</span>
                                    <span class="chat-header-status" id="currentChatStatus">All nodes</span>
                                </div>
                                <div class="chat-header-actions">
                                    <span id="msgCount" class="badge badge-info">0</span>
                                </div>
                            </div>

                            <!-- Messages Area -->
                            <div class="chat-messages" id="messagesList">
                                <div class="chat-messages-empty">
                                    <div class="empty-icon">üí¨</div>
                                    <h3>No Messages</h3>
                                    <p>Messages will appear here</p>
                                </div>
                            </div>

                            <!-- Message Input -->
                            <div class="chat-input-area">
                                <textarea
                                    id="messageText"
                                    class="chat-input"
                                    placeholder="Type a message... (Enter to send)"
                                    rows="1"
                                ></textarea>
                                <button id="sendBtn" class="chat-send-btn" disabled title="Send message">
                                    <span>‚û§</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden field to track current destination -->
                    <input type="hidden" id="destAddress" value="broadcast" />
                </div>

                <!-- GPS Map Tab -->
                <div id="mapTab" class="tab-content">
                    <div class="tab-header">
                        <h2>GPS Positions</h2>
                        <div class="map-controls">
                            <button id="centerMap" class="btn btn-secondary">Center Map</button>
                            <button id="toggleLabels" class="btn btn-secondary">Toggle Labels</button>
                        </div>
                    </div>

                    <div class="map-container">
                        <div id="map"></div>
                        <div class="map-overlay">
                            <div class="map-info">
                                <h4>Nodes on Map</h4>
                                <div id="mapNodesList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Console Tab -->
                <div id="consoleTab" class="tab-content">
                    <div class="tab-header">
                        <h2>Serial Console</h2>
                        <div class="console-controls">
                            <button id="clearConsole" class="btn btn-secondary">Clear</button>
                            <button id="exportLog" class="btn btn-secondary">Export Log</button>
                        </div>
                    </div>

                    <div class="console-container">
                        <div class="console" id="console">
                            <div class="console-line console-info">
                                <span class="timestamp">[00:00:00]</span>
                                <span class="message">LNK-22 Web Client initialized...</span>
                            </div>
                        </div>
                        <div class="console-input-row">
                            <span class="console-prompt">></span>
                            <input
                                type="text"
                                id="consoleInput"
                                class="console-input"
                                placeholder="Type command... (try: status, neighbors, routes, help)"
                                autocomplete="off"
                            />
                            <button id="sendCmdBtn" class="btn btn-primary" disabled>Send</button>
                        </div>
                        <div class="console-help">
                            <strong>Commands:</strong>
                            <code>status</code>
                            <code>neighbors</code>
                            <code>routes</code>
                            <code>link</code>
                            <code>group</code>
                            <code>queue</code>
                            <code>adr</code>
                            <code>name</code>
                            <code>history</code>
                            <code>help</code>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <div class="tab-header">
                        <h2>Settings</h2>
                    </div>

                    <div class="settings-grid">
                        <div class="settings-section">
                            <h3>üìª Radio Configuration</h3>
                            <div class="form-group">
                                <label>Frequency (MHz)</label>
                                <input type="number" class="input" value="915" step="0.1" min="900" max="930" />
                                <small>US ISM Band: 902-928 MHz</small>
                            </div>
                            <div class="form-group">
                                <label>Spreading Factor</label>
                                <select class="input" id="sfSelect">
                                    <option value="7">SF7 - Fastest (6.25 kbps)</option>
                                    <option value="8">SF8 - Fast (3.13 kbps)</option>
                                    <option value="9">SF9 - Balanced (1.76 kbps)</option>
                                    <option value="10" selected>SF10 - Long Range (1.0 kbps)</option>
                                    <option value="11">SF11 - Longer Range (537 bps)</option>
                                    <option value="12">SF12 - Maximum Range (293 bps)</option>
                                </select>
                                <small>Currently: SF10 (Long Range Mode)</small>
                            </div>
                            <div class="form-group">
                                <label>TX Power: <span id="powerValue">22</span> dBm</label>
                                <input type="range" id="powerSlider" class="input-range" min="2" max="22" value="22" />
                                <small>2 dBm (1.6 mW) - 22 dBm (158 mW)</small>
                            </div>
                            <div class="form-group">
                                <label>Channel</label>
                                <select class="input">
                                    <option value="0" selected>Channel 0 (Default)</option>
                                    <option value="1">Channel 1</option>
                                    <option value="2">Channel 2</option>
                                    <option value="3">Channel 3</option>
                                    <option value="4">Channel 4</option>
                                    <option value="5">Channel 5</option>
                                    <option value="6">Channel 6</option>
                                    <option value="7">Channel 7 (Admin)</option>
                                </select>
                            </div>
                            <button class="btn btn-primary">Apply Radio Settings</button>
                        </div>

                        <div class="settings-section">
                            <h3>üè∑Ô∏è Node Naming</h3>
                            <div class="form-group">
                                <label>This Node's Name</label>
                                <div class="input-group">
                                    <input type="text" id="nodeNameInput" class="input" placeholder="My LNK-22 Node" maxlength="16" />
                                    <button id="setNodeNameBtn" class="btn btn-primary">Set</button>
                                </div>
                                <small>Max 16 characters, alphanumeric</small>
                            </div>
                            <div class="form-group">
                                <label>Known Nodes</label>
                                <div id="knownNodesList" class="known-nodes-list">
                                    <p class="text-muted">Connect to see known nodes</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Add Nickname for Node</label>
                                <div class="input-row">
                                    <input type="text" id="newNodeAddr" class="input" placeholder="0xABCD1234" />
                                    <input type="text" id="newNodeName" class="input" placeholder="Name" maxlength="16" />
                                </div>
                                <button id="addNodeNameBtn" class="btn btn-secondary btn-block">Add Name</button>
                            </div>
                        </div>

                        <!-- Secure Links Section -->
                        <div class="settings-section">
                            <h3>üîí Secure Links</h3>
                            <div id="linksStatus">
                                <p class="text-muted">No active secure links</p>
                            </div>
                            <div class="form-group">
                                <label>Establish New Link</label>
                                <div class="input-group">
                                    <input type="text" id="linkTargetInput" class="input" placeholder="Node name or 0xAddress" />
                                    <button class="btn btn-primary" onclick="establishLink(document.getElementById('linkTargetInput').value)">Connect</button>
                                </div>
                                <small>Links provide encrypted end-to-end communication with forward secrecy</small>
                            </div>
                        </div>

                        <!-- Group Channels Section -->
                        <div class="settings-section">
                            <h3>üë• Group Channels</h3>
                            <div id="groupsStatus">
                                <p class="text-muted">No active groups</p>
                            </div>
                            <div class="form-group">
                                <label>Create New Group</label>
                                <div class="input-group">
                                    <input type="text" id="newGroupName" class="input" placeholder="Group name" maxlength="16" />
                                    <button id="createGroupBtn" class="btn btn-primary">Create</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Join Existing Group</label>
                                <div class="input-row">
                                    <input type="text" id="joinGroupName" class="input" placeholder="Group name" />
                                    <input type="text" id="joinGroupKey" class="input" placeholder="64-char hex key" />
                                </div>
                                <button class="btn btn-secondary btn-block" onclick="sendCommand('group join ' + document.getElementById('joinGroupName').value + ' ' + document.getElementById('joinGroupKey').value)">Join Group</button>
                            </div>
                        </div>

                        <!-- Store-and-Forward Section -->
                        <div class="settings-section">
                            <h3>üì¶ Store-and-Forward</h3>
                            <div id="sfStatus">
                                <p class="text-muted">Queue empty</p>
                            </div>
                            <button class="btn btn-secondary" onclick="sendCommand('queue')">Refresh Queue</button>
                            <button class="btn btn-danger" onclick="if(confirm('Clear all queued messages?')) sendCommand('queue clear')">Clear Queue</button>
                        </div>

                        <!-- ADR Section -->
                        <div class="settings-section">
                            <h3>üì∂ Adaptive Data Rate</h3>
                            <div id="adrStatus">
                                <p class="text-muted">Loading ADR status...</p>
                            </div>
                        </div>

                        <!-- Emergency SOS Section -->
                        <div class="settings-section emergency-section">
                            <h3>üö® Emergency SOS</h3>
                            <div id="sosStatus">
                                <p class="text-muted">Emergency SOS ready</p>
                            </div>
                            <button id="sosButton" class="btn btn-danger sos-button" onclick="activateSOS()">
                                üÜò EMERGENCY SOS
                            </button>
                            <small class="text-muted">Broadcasts your location and distress signal to all nodes</small>
                        </div>

                        <div class="settings-section">
                            <h3>üîß Network Configuration</h3>
                            <div class="form-group">
                                <label>Beacon Interval (seconds)</label>
                                <input type="number" class="input" value="30" min="10" max="300" />
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked />
                                    Enable GPS
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked />
                                    Auto-ACK Messages
                                </label>
                            </div>
                            <button class="btn btn-primary">Save Network Settings</button>
                        </div>

                        <div class="settings-section">
                            <h3>üé® Display Options</h3>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="darkMode" />
                                    Dark Mode
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked />
                                    Show Packet Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked />
                                    Animate Network Graph
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Refresh Interval (ms)</label>
                                <input type="number" class="input" value="1000" min="100" max="5000" step="100" />
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>‚ÑπÔ∏è About</h3>
                            <div class="about-info">
                                <p><strong>LNK-22 Mesh Network</strong></p>
                                <div id="versionInfo" class="version-info">
                                    <div class="version-row">
                                        <span>Web Client:</span> <code id="aboutVersion">1.8.0</code>
                                    </div>
                                    <div class="version-row">
                                        <span>Firmware:</span> <code id="aboutFirmware">Unknown</code>
                                    </div>
                                </div>
                                <hr/>
                                <p>RadioLib: 6.6.0</p>
                                <p>Protocol: AODV + DTN</p>
                                <p>Board: RAK4631</p>
                                <hr/>
                                <p><strong>Features (v1.8.0):</strong></p>
                                <ul class="feature-list">
                                    <li>‚úÖ Store-and-Forward Messaging</li>
                                    <li>‚úÖ Adaptive Data Rate (ADR)</li>
                                    <li>‚úÖ Emergency SOS Mode</li>
                                    <li>‚úÖ Message History</li>
                                    <li>‚úÖ Secure Links (X25519)</li>
                                    <li>‚úÖ DTN Bundle Protocol</li>
                                    <li>‚úÖ Geographic Routing (GPSR)</li>
                                    <li>‚úÖ Encrypted Group Channels</li>
                                    <li>‚úÖ Forward Secrecy (Double Ratchet)</li>
                                </ul>
                                <hr/>
                                <p class="text-muted">
                                    Professional LoRa mesh networking firmware with
                                    autonomous operation, multi-hop routing, and
                                    end-to-end encryption.
                                </p>
                                <button class="btn btn-secondary btn-block">View Documentation</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <script type="module" src="/src/main-enhanced.js?v=1.9.1"></script>
</body>
</html>
