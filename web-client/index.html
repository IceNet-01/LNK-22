<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LNK-22 Mesh Network Control v1.9.0</title>
    <link rel="stylesheet" href="/src/style-enhanced.css?v=1.9.0">

    <!-- D3.js for network graph -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <h1>üõ∞Ô∏è LNK-22 Mesh Network</h1>
                    <div class="subtitle">Real-Time Mesh Monitoring & Control <span class="version-badge">v1.8.0</span></div>
                </div>
                <div class="header-actions">
                    <div class="connection-status">
                        <span id="statusIndicator" class="status-dot disconnected"></span>
                        <span id="statusText">Disconnected</span>
                    </div>
                    <button id="connectBtn" class="btn btn-primary">
                        <span class="btn-icon">üîå</span>
                        Connect Device
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <nav class="nav">
                    <button class="nav-item active" data-tab="dashboard">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-label">Dashboard</span>
                    </button>
                    <button class="nav-item" data-tab="network">
                        <span class="nav-icon">üåê</span>
                        <span class="nav-label">Network Graph</span>
                    </button>
                    <button class="nav-item" data-tab="routes">
                        <span class="nav-icon">üó∫Ô∏è</span>
                        <span class="nav-label">Routing Table</span>
                    </button>
                    <button class="nav-item" data-tab="neighbors">
                        <span class="nav-icon">üì°</span>
                        <span class="nav-label">ARP Table</span>
                    </button>
                    <button class="nav-item" data-tab="tdma">
                        <span class="nav-icon">‚è±Ô∏è</span>
                        <span class="nav-label">TDMA/MAC</span>
                    </button>
                    <button class="nav-item" data-tab="radio">
                        <span class="nav-icon">üìª</span>
                        <span class="nav-label">Radio Status</span>
                    </button>
                    <button class="nav-item" data-tab="messages">
                        <span class="nav-icon">üí¨</span>
                        <span class="nav-label">Messages</span>
                    </button>
                    <button class="nav-item" data-tab="map">
                        <span class="nav-icon">üìç</span>
                        <span class="nav-label">GPS Map</span>
                    </button>
                    <button class="nav-item" data-tab="console">
                        <span class="nav-icon">‚å®Ô∏è</span>
                        <span class="nav-label">Console</span>
                    </button>
                    <button class="nav-item" data-tab="settings">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span class="nav-label">Settings</span>
                    </button>
                </nav>

                <!-- Device Info Card -->
                <div class="device-card">
                    <div class="device-card-header">
                        <h3>Connected Device</h3>
                        <span id="deviceStatus" class="badge badge-gray">Offline</span>
                    </div>
                    <div class="device-info">
                        <div class="info-item">
                            <span class="label">Address</span>
                            <code id="deviceAddress" class="value">-</code>
                        </div>
                        <div class="info-item">
                            <span class="label">Uptime</span>
                            <span id="deviceUptime" class="value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Signal</span>
                            <div class="signal-bars">
                                <span id="deviceRSSI" class="value">- dBm</span>
                                <div id="signalStrength" class="signal-indicator"></div>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="label">SNR</span>
                            <span id="deviceSNR" class="value">- dB</span>
                        </div>
                    </div>
                    <div class="device-stats">
                        <div class="stat">
                            <div class="stat-value" id="neighborCount">0</div>
                            <div class="stat-label">Neighbors</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="routeCount">0</div>
                            <div class="stat-label">Routes</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Content Area -->
            <main class="content">
                <!-- Dashboard Tab -->
                <div id="dashboardTab" class="tab-content active">
                    <div class="tab-header">
                        <h2>Network Dashboard</h2>
                        <button id="refreshBtn" class="btn btn-secondary">
                            <span class="btn-icon">üîÑ</span>
                            Refresh
                        </button>
                    </div>

                    <!-- Stats Overview -->
                    <div class="stats-row">
                        <div class="stat-card stat-card-primary">
                            <div class="stat-card-icon">üì°</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="totalPackets">0</div>
                                <div class="stat-card-label">Total Packets</div>
                            </div>
                        </div>
                        <div class="stat-card stat-card-success">
                            <div class="stat-card-icon">üì§</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="packetsSent">0</div>
                                <div class="stat-card-label">Packets Sent</div>
                            </div>
                        </div>
                        <div class="stat-card stat-card-info">
                            <div class="stat-card-icon">üì•</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="packetsReceived">0</div>
                                <div class="stat-card-label">Packets Received</div>
                            </div>
                        </div>
                        <div class="stat-card stat-card-warning">
                            <div class="stat-card-icon">üîó</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="activeNeighbors">0</div>
                                <div class="stat-card-label">Neighbors</div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Features Stats (v1.5.0+) -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-card-icon">üîí</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="activeLinkCount">0</div>
                                <div class="stat-card-label">Secure Links</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">üë•</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="activeGroupCount">0</div>
                                <div class="stat-card-label">Groups</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">üì¶</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="sfQueueCount">0</div>
                                <div class="stat-card-label">Store & Forward</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon" id="sosStatusIcon">üÜò</div>
                            <div class="stat-card-content">
                                <div class="stat-card-value" id="sosStatusText">Ready</div>
                                <div class="stat-card-label">Emergency SOS</div>
                            </div>
                        </div>
                    </div>

                    <!-- Neighbor Status Grid -->
                    <div class="section">
                        <div class="section-header">
                            <h3>üì° Neighbor Status</h3>
                            <span id="lastUpdate" class="text-muted">Last updated: Never</span>
                        </div>
                        <div id="neighborsGrid" class="neighbors-grid">
                            <div class="empty-state">
                                <div class="empty-icon">üîç</div>
                                <p>No neighbors discovered yet</p>
                                <p class="text-muted">Waiting for beacon broadcasts...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Packet Activity Chart -->
                    <div class="section">
                        <div class="section-header">
                            <h3>üìà Packet Activity</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="packetChart"></canvas>
                        </div>
                    </div>

                    <!-- Signal Quality History -->
                    <div class="section">
                        <div class="section-header">
                            <h3>üìä Signal Quality</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="signalChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Network Graph Tab -->
                <div id="networkTab" class="tab-content">
                    <div class="tab-header">
                        <h2>Network Topology</h2>
                        <div class="graph-controls">
                            <button id="centerGraph" class="btn btn-secondary">Center</button>
                            <button id="freezeGraph" class="btn btn-secondary">Freeze</button>
                        </div>
                    </div>

                    <div class="graph-container">
                        <svg id="networkGraph"></svg>

                        <div class="graph-legend">
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #4CAF50"></span>
                                <span>This Node</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #2196F3"></span>
                                <span>Direct Neighbor</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #FF9800"></span>
                                <span>2+ Hops</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-line" style="background: #4CAF50; height: 3px"></span>
                                <span>Strong Signal</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-line" style="background: #FF5722; height: 2px"></span>
                                <span>Weak Signal</span>
                            </div>
                        </div>
                    </div>

                    <div class="graph-info">
                        <div class="info-card">
                            <h4>Graph Statistics</h4>
                            <div class="info-grid">
                                <div><strong>Total Nodes:</strong> <span id="graphNodeCount">0</span></div>
                                <div><strong>Total Links:</strong> <span id="graphLinkCount">0</span></div>
                                <div><strong>Network Diameter:</strong> <span id="graphDiameter">-</span></div>
                                <div><strong>Avg Hop Count:</strong> <span id="graphAvgHops">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Routes Tab -->
                <div id="routesTab" class="tab-content">
                    <div class="tab-header">
                        <h2>Routing Table</h2>
                        <button id="refreshRoutes" class="btn btn-secondary">Refresh</button>
                    </div>

                    <div class="routes-container">
                        <table class="table table-enhanced">
                            <thead>
                                <tr>
                                    <th>Destination</th>
                                    <th>Next Hop</th>
                                    <th>Hops</th>
                                    <th>Quality</th>
                                    <th>Age</th>
                                    <th>Path</th>
                                </tr>
                            </thead>
                            <tbody id="routesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="empty-state-inline">
                                            <span>üì≠</span> No routes in routing table
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="route-visual" id="routeVisual">
                            <h3>Route Visualization</h3>
                            <p class="text-muted">Select a route to see the path visualization</p>
                        </div>
                    </div>
                </div>

                <!-- ARP/Neighbors Tab -->
                <div id="neighborsTab" class="tab-content">
                    <div class="tab-header">
                        <h2>ARP / Neighbor Table</h2>
                        <button id="refreshNeighbors" class="btn btn-secondary" onclick="sendCommand('neighbors')">Refresh</button>
                    </div>

                    <div class="neighbors-container">
                        <!-- Neighbor Stats -->
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-card-icon">üë•</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="arpNeighborCount">0</div>
                                    <div class="stat-card-label">Total Neighbors</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-icon">üì∂</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="arpAvgRSSI">-</div>
                                    <div class="stat-card-label">Avg RSSI</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-icon">‚è∞</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="arpLastSeen">-</div>
                                    <div class="stat-card-label">Last Beacon</div>
                                </div>
                            </div>
                        </div>

                        <!-- Neighbor Table -->
                        <div class="section">
                            <table class="table table-enhanced">
                                <thead>
                                    <tr>
                                        <th>Node</th>
                                        <th>Address</th>
                                        <th>RSSI</th>
                                        <th>SNR</th>
                                        <th>Quality</th>
                                        <th>Last Seen</th>
                                        <th>Packets</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="arpTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="empty-state-inline">
                                                <span>üì°</span> No neighbors discovered
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Signal Strength Visual -->
                        <div class="section">
                            <h3>Signal Strength Map</h3>
                            <div id="signalMap" class="signal-map">
                                <div class="signal-map-legend">
                                    <span class="legend-item"><span class="dot excellent"></span> Excellent (&gt;-70)</span>
                                    <span class="legend-item"><span class="dot good"></span> Good (-70 to -85)</span>
                                    <span class="legend-item"><span class="dot fair"></span> Fair (-85 to -100)</span>
                                    <span class="legend-item"><span class="dot poor"></span> Poor (&lt;-100)</span>
                                </div>
                                <div id="signalMapNodes" class="signal-map-nodes">
                                    <p class="text-muted">Connect to see neighbor signal strengths</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TDMA/MAC Tab -->
                <div id="tdmaTab" class="tab-content">
                    <div class="tab-header">
                        <h2>TDMA / MAC Layer</h2>
                        <button id="refreshMAC" class="btn btn-secondary" onclick="sendCommand('mac')">Refresh</button>
                    </div>

                    <div class="tdma-container">
                        <!-- MAC Status Overview -->
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-card-icon">‚è±Ô∏è</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="tdmaFrame">-</div>
                                    <div class="stat-card-label">Current Frame</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-icon">üìä</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="tdmaSlot">-</div>
                                    <div class="stat-card-label">Current Slot</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-icon">üïê</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="timeSource">-</div>
                                    <div class="stat-card-label">Time Source</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-icon">üìà</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="timeQuality">-</div>
                                    <div class="stat-card-label">Time Quality</div>
                                </div>
                            </div>
                        </div>

                        <!-- TDMA Controls -->
                        <div class="section">
                            <h3>MAC Layer Controls</h3>
                            <div class="tdma-controls">
                                <button class="btn btn-primary" onclick="sendCommand('mac on')">Enable TDMA</button>
                                <button class="btn btn-secondary" onclick="sendCommand('mac off')">CSMA Only</button>
                                <button class="btn btn-secondary" onclick="sendCommand('mac sync')">Broadcast Time Sync</button>
                                <button class="btn btn-secondary" onclick="setTimeFromHost()">Set Time from Host</button>
                            </div>
                        </div>

                        <!-- Time Slot Visualization -->
                        <div class="section">
                            <h3>Time Slot Allocation (1s Frame / 10 Slots)</h3>
                            <div class="slot-visualization" id="slotVisualization">
                                <div class="slot-row">
                                    <div class="slot slot-beacon" data-slot="0" title="Slot 0: BEACON">
                                        <span class="slot-num">0</span>
                                        <span class="slot-type">BCN</span>
                                    </div>
                                    <div class="slot slot-free" data-slot="1" title="Slot 1: FREE">
                                        <span class="slot-num">1</span>
                                        <span class="slot-type">FREE</span>
                                    </div>
                                    <div class="slot slot-free" data-slot="2" title="Slot 2: FREE">
                                        <span class="slot-num">2</span>
                                        <span class="slot-type">FREE</span>
                                    </div>
                                    <div class="slot slot-free" data-slot="3" title="Slot 3: FREE">
                                        <span class="slot-num">3</span>
                                        <span class="slot-type">FREE</span>
                                    </div>
                                    <div class="slot slot-free" data-slot="4" title="Slot 4: FREE">
                                        <span class="slot-num">4</span>
                                        <span class="slot-type">FREE</span>
                                    </div>
                                    <div class="slot slot-free" data-slot="5" title="Slot 5: FREE">
                                        <span class="slot-num">5</span>
                                        <span class="slot-type">FREE</span>
                                    </div>
                                    <div class="slot slot-free" data-slot="6" title="Slot 6: FREE">
                                        <span class="slot-num">6</span>
                                        <span class="slot-type">FREE</span>
                                    </div>
                                    <div class="slot slot-free" data-slot="7" title="Slot 7: FREE">
                                        <span class="slot-num">7</span>
                                        <span class="slot-type">FREE</span>
                                    </div>
                                    <div class="slot slot-free" data-slot="8" title="Slot 8: FREE">
                                        <span class="slot-num">8</span>
                                        <span class="slot-type">FREE</span>
                                    </div>
                                    <div class="slot slot-free" data-slot="9" title="Slot 9: FREE">
                                        <span class="slot-num">9</span>
                                        <span class="slot-type">FREE</span>
                                    </div>
                                </div>
                                <div class="slot-legend">
                                    <span class="legend-item"><span class="slot-sample slot-beacon"></span> Beacon</span>
                                    <span class="legend-item"><span class="slot-sample slot-reserved"></span> Reserved (This Node)</span>
                                    <span class="legend-item"><span class="slot-sample slot-peer"></span> Peer Reserved</span>
                                    <span class="legend-item"><span class="slot-sample slot-free"></span> Free (CSMA)</span>
                                    <span class="legend-item"><span class="slot-sample slot-current"></span> Current</span>
                                </div>
                            </div>
                        </div>

                        <!-- MAC Statistics -->
                        <div class="section">
                            <h3>MAC Statistics</h3>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">TDMA TX</span>
                                    <span class="stat-value" id="tdmaTxCount">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">CSMA TX</span>
                                    <span class="stat-value" id="csmaTxCount">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Collisions</span>
                                    <span class="stat-value" id="collisionCount">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">CCA Busy</span>
                                    <span class="stat-value" id="ccaBusyCount">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Time Syncs</span>
                                    <span class="stat-value" id="timeSyncCount">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Stratum</span>
                                    <span class="stat-value" id="timeStratum">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Time Sync Info -->
                        <div class="section">
                            <h3>Time Synchronization</h3>
                            <div class="time-sync-info">
                                <p>Time source priority: <strong>GPS</strong> &gt; <strong>NTP</strong> &gt; <strong>Serial</strong> &gt; <strong>Synced</strong> &gt; <strong>Crystal</strong></p>
                                <p>Nodes with better time sources automatically become time masters and broadcast sync to the network.</p>
                                <div class="time-sync-status" id="timeSyncStatus">
                                    <span class="status-indicator"></span>
                                    <span class="status-text">Connect to view time sync status</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Radio Status Tab -->
                <div id="radioTab" class="tab-content">
                    <div class="tab-header">
                        <h2>Radio Status</h2>
                        <button id="refreshRadio" class="btn btn-secondary" onclick="sendCommand('radio')">Refresh</button>
                    </div>

                    <div class="radio-container">
                        <!-- Radio Overview -->
                        <div class="stats-row">
                            <div class="stat-card stat-card-primary">
                                <div class="stat-card-icon">üìª</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="radioFrequency">915.0</div>
                                    <div class="stat-card-label">Frequency (MHz)</div>
                                </div>
                            </div>
                            <div class="stat-card stat-card-success">
                                <div class="stat-card-icon">üì∂</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="radioTxPower">22</div>
                                    <div class="stat-card-label">TX Power (dBm)</div>
                                </div>
                            </div>
                            <div class="stat-card stat-card-info">
                                <div class="stat-card-icon">üìä</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="radioSF">SF10</div>
                                    <div class="stat-card-label">Spreading Factor</div>
                                </div>
                            </div>
                            <div class="stat-card stat-card-warning">
                                <div class="stat-card-icon">üî¢</div>
                                <div class="stat-card-content">
                                    <div class="stat-card-value" id="radioChannel">0</div>
                                    <div class="stat-card-label">Channel</div>
                                </div>
                            </div>
                        </div>

                        <!-- MAC Mode Status -->
                        <div class="section">
                            <h3>MAC Layer Mode</h3>
                            <div class="mac-mode-display">
                                <div class="mac-mode-indicator" id="macModeIndicator">
                                    <div class="mode-icon">üì°</div>
                                    <div class="mode-info">
                                        <div class="mode-name" id="macModeName">CSMA-CA</div>
                                        <div class="mode-desc" id="macModeDesc">Carrier-sense multiple access with collision avoidance</div>
                                    </div>
                                    <div class="mode-status" id="macModeStatus">
                                        <span class="badge badge-warning">Fallback Mode</span>
                                    </div>
                                </div>
                            </div>

                            <div class="mac-mode-info">
                                <div class="mode-detail">
                                    <span class="detail-label">TDMA Status:</span>
                                    <span class="detail-value" id="tdmaStatusText">Disabled (no time sync)</span>
                                </div>
                                <div class="mode-detail">
                                    <span class="detail-label">Time Quality:</span>
                                    <span class="detail-value" id="timeQualityText">Crystal only</span>
                                </div>
                                <div class="mode-detail">
                                    <span class="detail-label">Assigned Slot:</span>
                                    <span class="detail-value" id="assignedSlotText">None</span>
                                </div>
                            </div>
                        </div>

                        <!-- Signal Quality -->
                        <div class="section">
                            <h3>Signal Quality</h3>
                            <div class="signal-quality-row">
                                <div class="signal-metric">
                                    <div class="metric-label">Last RSSI</div>
                                    <div class="metric-value" id="radioRSSI">-65 dBm</div>
                                    <div class="metric-bar">
                                        <div class="metric-bar-fill" id="rssiBarFill" style="width: 70%"></div>
                                    </div>
                                </div>
                                <div class="signal-metric">
                                    <div class="metric-label">Last SNR</div>
                                    <div class="metric-value" id="radioSNR">9 dB</div>
                                    <div class="metric-bar">
                                        <div class="metric-bar-fill snr" id="snrBarFill" style="width: 80%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Radio Statistics -->
                        <div class="section">
                            <h3>Radio Statistics</h3>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">TX Packets</span>
                                    <span class="stat-value" id="radioTxPackets">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">RX Packets</span>
                                    <span class="stat-value" id="radioRxPackets">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">CRC Errors</span>
                                    <span class="stat-value" id="radioCrcErrors">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">TX Errors</span>
                                    <span class="stat-value" id="radioTxErrors">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Duty Cycle</span>
                                    <span class="stat-value" id="radioDutyCycle">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Air Time</span>
                                    <span class="stat-value" id="radioAirTime">0s</span>
                                </div>
                            </div>
                        </div>

                        <!-- Mode Explanation -->
                        <div class="section">
                            <h3>About MAC Modes</h3>
                            <div class="mode-explanation">
                                <div class="mode-card">
                                    <h4>‚è±Ô∏è TDMA Mode</h4>
                                    <p>Time Division Multiple Access - synchronized time slots prevent collisions. Requires network time synchronization (GPS, NTP, or synced peer).</p>
                                    <ul>
                                        <li>Better throughput in dense networks</li>
                                        <li>Guaranteed transmission slots</li>
                                        <li>Lower latency for scheduled transmissions</li>
                                    </ul>
                                </div>
                                <div class="mode-card">
                                    <h4>üì° CSMA-CA Mode</h4>
                                    <p>Carrier Sense Multiple Access with Collision Avoidance - listens before transmitting, backs off on busy channel.</p>
                                    <ul>
                                        <li>Works without time sync</li>
                                        <li>Good for sparse networks</li>
                                        <li>Automatic fallback mode</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab - Meshtastic-style layout -->
                <div id="messagesTab" class="tab-content">
                    <div class="chat-container">
                        <!-- Left Sidebar: Channels & DMs -->
                        <div class="chat-sidebar">
                            <div class="chat-sidebar-header">
                                <h3>Conversations</h3>
                                <button id="clearMessages" class="btn btn-icon" title="Clear All">üóëÔ∏è</button>
                            </div>

                            <!-- Channels Section -->
                            <div class="chat-section">
                                <div class="chat-section-title">Channels</div>
                                <div class="chat-list" id="channelList">
                                    <div class="chat-item active" data-chat="broadcast">
                                        <span class="chat-icon">üì¢</span>
                                        <div class="chat-info">
                                            <span class="chat-name">Broadcast</span>
                                            <span class="chat-preview">All nodes</span>
                                        </div>
                                        <span class="chat-unread" id="broadcastUnread" style="display:none">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Direct Messages Section -->
                            <div class="chat-section">
                                <div class="chat-section-title">Direct Messages</div>
                                <div class="chat-list" id="dmList">
                                    <!-- Populated dynamically from neighbors -->
                                    <div class="chat-empty">No neighbors discovered</div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Chat Area -->
                        <div class="chat-main">
                            <!-- Chat Header -->
                            <div class="chat-header">
                                <div class="chat-header-info">
                                    <span class="chat-header-icon">üì¢</span>
                                    <span class="chat-header-name" id="currentChatName">Broadcast</span>
                                    <span class="chat-header-status" id="currentChatStatus">All nodes</span>
                                </div>
                                <div class="chat-header-actions">
                                    <span id="msgCount" class="badge badge-info">0</span>
                                </div>
                            </div>

                            <!-- Messages Area -->
                            <div class="chat-messages" id="messagesList">
                                <div class="chat-messages-empty">
                                    <div class="empty-icon">üí¨</div>
                                    <h3>No Messages</h3>
                                    <p>Messages will appear here</p>
                                </div>
                            </div>

                            <!-- Message Input -->
                            <div class="chat-input-area">
                                <textarea
                                    id="messageText"
                                    class="chat-input"
                                    placeholder="Type a message... (Enter to send)"
                                    rows="1"
                                ></textarea>
                                <button id="sendBtn" class="chat-send-btn" disabled title="Send message">
                                    <span>‚û§</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden field to track current destination -->
                    <input type="hidden" id="destAddress" value="broadcast" />
                </div>

                <!-- GPS Map Tab -->
                <div id="mapTab" class="tab-content">
                    <div class="tab-header">
                        <h2>GPS Positions</h2>
                        <div class="map-controls">
                            <button id="centerMap" class="btn btn-secondary">Center Map</button>
                            <button id="toggleLabels" class="btn btn-secondary">Toggle Labels</button>
                        </div>
                    </div>

                    <div class="map-container">
                        <div id="map"></div>
                        <div class="map-overlay">
                            <div class="map-info">
                                <h4>Nodes on Map</h4>
                                <div id="mapNodesList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Console Tab -->
                <div id="consoleTab" class="tab-content">
                    <div class="tab-header">
                        <h2>Serial Console</h2>
                        <div class="console-controls">
                            <div class="console-filters">
                                <button class="console-filter-btn active" data-filter="all" onclick="setConsoleFilter('all')">All</button>
                                <button class="console-filter-btn" data-filter="messages" onclick="setConsoleFilter('messages')">Messages</button>
                                <button class="console-filter-btn" data-filter="network" onclick="setConsoleFilter('network')">Network</button>
                                <button class="console-filter-btn" data-filter="errors" onclick="setConsoleFilter('errors')">Errors</button>
                            </div>
                            <button id="clearConsole" class="btn btn-secondary">Clear</button>
                            <button id="exportLog" class="btn btn-secondary">Export Log</button>
                        </div>
                    </div>

                    <div class="console-container">
                        <div class="console" id="console">
                            <div class="console-line console-info console-cat-success" data-category="success">
                                <span class="timestamp">[00:00:00]</span>
                                <span class="cat-icon">‚úÖ </span>
                                <span class="message">LNK-22 Web Client initialized...</span>
                            </div>
                        </div>
                        <div class="console-scroll-indicator" id="scrollIndicator" style="display:none">
                            <button onclick="scrollConsoleToBottom()">‚¨áÔ∏è New messages below</button>
                        </div>
                        <div class="console-input-row">
                            <span class="console-prompt">></span>
                            <input
                                type="text"
                                id="consoleInput"
                                class="console-input"
                                placeholder="Type command... (try: status, neighbors, routes, help)"
                                autocomplete="off"
                            />
                            <button id="sendCmdBtn" class="btn btn-primary" disabled>Send</button>
                        </div>
                        <div class="console-help">
                            <strong>Commands:</strong>
                            <code>status</code>
                            <code>neighbors</code>
                            <code>routes</code>
                            <code>link</code>
                            <code>group</code>
                            <code>queue</code>
                            <code>adr</code>
                            <code>name</code>
                            <code>history</code>
                            <code>help</code>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <div class="tab-header">
                        <h2>Settings</h2>
                    </div>

                    <div class="settings-grid">
                        <div class="settings-section">
                            <h3>üìª Radio Configuration</h3>
                            <div class="form-group">
                                <label>Frequency (MHz)</label>
                                <input type="number" class="input" value="915" step="0.1" min="900" max="930" />
                                <small>US ISM Band: 902-928 MHz</small>
                            </div>
                            <div class="form-group">
                                <label>Spreading Factor</label>
                                <select class="input" id="sfSelect">
                                    <option value="7">SF7 - Fastest (6.25 kbps)</option>
                                    <option value="8">SF8 - Fast (3.13 kbps)</option>
                                    <option value="9">SF9 - Balanced (1.76 kbps)</option>
                                    <option value="10" selected>SF10 - Long Range (1.0 kbps)</option>
                                    <option value="11">SF11 - Longer Range (537 bps)</option>
                                    <option value="12">SF12 - Maximum Range (293 bps)</option>
                                </select>
                                <small>Currently: SF10 (Long Range Mode)</small>
                            </div>
                            <div class="form-group">
                                <label>TX Power: <span id="powerValue">22</span> dBm</label>
                                <input type="range" id="powerSlider" class="input-range" min="2" max="22" value="22" />
                                <small>2 dBm (1.6 mW) - 22 dBm (158 mW)</small>
                            </div>
                            <div class="form-group">
                                <label>Channel</label>
                                <select class="input">
                                    <option value="0" selected>Channel 0 (Default)</option>
                                    <option value="1">Channel 1</option>
                                    <option value="2">Channel 2</option>
                                    <option value="3">Channel 3</option>
                                    <option value="4">Channel 4</option>
                                    <option value="5">Channel 5</option>
                                    <option value="6">Channel 6</option>
                                    <option value="7">Channel 7 (Admin)</option>
                                </select>
                            </div>
                            <button class="btn btn-primary">Apply Radio Settings</button>
                        </div>

                        <div class="settings-section">
                            <h3>üè∑Ô∏è Node Naming</h3>
                            <div class="form-group">
                                <label>This Node's Name</label>
                                <div class="input-group">
                                    <input type="text" id="nodeNameInput" class="input" placeholder="My LNK-22 Node" maxlength="16" />
                                    <button id="setNodeNameBtn" class="btn btn-primary">Set</button>
                                </div>
                                <small>Max 16 characters, alphanumeric</small>
                            </div>
                            <div class="form-group">
                                <label>Known Nodes</label>
                                <div id="knownNodesList" class="known-nodes-list">
                                    <p class="text-muted">Connect to see known nodes</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Add Nickname for Node</label>
                                <div class="input-row">
                                    <input type="text" id="newNodeAddr" class="input" placeholder="0xABCD1234" />
                                    <input type="text" id="newNodeName" class="input" placeholder="Name" maxlength="16" />
                                </div>
                                <button id="addNodeNameBtn" class="btn btn-secondary btn-block">Add Name</button>
                            </div>
                        </div>

                        <!-- Secure Links Section -->
                        <div class="settings-section">
                            <h3>üîí Secure Links</h3>
                            <p class="section-desc">End-to-end encrypted connections with perfect forward secrecy</p>
                            <div id="linksStatus">
                                <p class="text-muted">No active secure links</p>
                            </div>
                            <div class="form-group">
                                <label>Establish New Link</label>
                                <div class="link-connect-ui">
                                    <select id="linkTargetSelect" class="input link-select">
                                        <option value="">Select a neighbor...</option>
                                    </select>
                                    <span class="link-or">or</span>
                                    <input type="text" id="linkTargetInput" class="input" placeholder="Name or 0xAddress" />
                                    <button class="btn btn-primary btn-connect" onclick="establishLinkFromUI()">
                                        <span class="btn-icon">üîó</span> Connect
                                    </button>
                                </div>
                                <div class="link-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="linkForwardSecrecy" checked />
                                        <span>Enable Forward Secrecy (ECDH + AES-GCM)</span>
                                    </label>
                                </div>
                                <div class="link-help">
                                    <strong>How it works:</strong>
                                    <ol>
                                        <li>Select a neighbor or enter their address</li>
                                        <li>Click Connect to initiate key exchange</li>
                                        <li>Both nodes must approve the link</li>
                                        <li>All messages are encrypted end-to-end</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <!-- Group Channels Section -->
                        <div class="settings-section">
                            <h3>üë• Encrypted Channels</h3>
                            <p class="section-desc">Private group communication with shared encryption keys</p>
                            <div id="groupsStatus">
                                <p class="text-muted">No active channels</p>
                            </div>

                            <div class="channel-tabs">
                                <button class="channel-tab active" onclick="showChannelTab('create')">Create Channel</button>
                                <button class="channel-tab" onclick="showChannelTab('join')">Join Channel</button>
                            </div>

                            <div id="createChannelPane" class="channel-pane active">
                                <div class="form-group">
                                    <label>Channel Name</label>
                                    <input type="text" id="newGroupName" class="input" placeholder="e.g., TeamAlpha" maxlength="16" />
                                </div>
                                <div class="form-group">
                                    <label>Security Level</label>
                                    <div class="radio-group">
                                        <label class="radio-label">
                                            <input type="radio" name="channelSecurity" value="auto" checked />
                                            <span>Auto-generate key (recommended)</span>
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio" name="channelSecurity" value="custom" />
                                            <span>Custom key (advanced)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group" id="customKeyGroup" style="display:none">
                                    <label>Custom Key (64 hex chars)</label>
                                    <input type="text" id="customChannelKey" class="input mono" placeholder="Enter 64 hexadecimal characters" maxlength="64" />
                                </div>
                                <button id="createGroupBtn" class="btn btn-primary btn-block">
                                    <span class="btn-icon">+</span> Create Channel
                                </button>
                                <div class="channel-help">
                                    After creating, share the channel key with others to let them join.
                                </div>
                            </div>

                            <div id="joinChannelPane" class="channel-pane">
                                <div class="form-group">
                                    <label>Channel Name</label>
                                    <input type="text" id="joinGroupName" class="input" placeholder="Channel name" />
                                </div>
                                <div class="form-group">
                                    <label>Channel Key</label>
                                    <input type="text" id="joinGroupKey" class="input mono" placeholder="Paste 64-char key from channel creator" />
                                </div>
                                <button class="btn btn-primary btn-block" onclick="joinChannel()">
                                    <span class="btn-icon">üîì</span> Join Channel
                                </button>
                                <div class="channel-help">
                                    Get the channel name and key from someone already in the channel.
                                </div>
                            </div>
                        </div>

                        <!-- Store-and-Forward Section -->
                        <div class="settings-section">
                            <h3>üì¶ Store-and-Forward</h3>
                            <div id="sfStatus">
                                <p class="text-muted">Queue empty</p>
                            </div>
                            <button class="btn btn-secondary" onclick="sendCommand('queue')">Refresh Queue</button>
                            <button class="btn btn-danger" onclick="if(confirm('Clear all queued messages?')) sendCommand('queue clear')">Clear Queue</button>
                        </div>

                        <!-- ADR Section -->
                        <div class="settings-section">
                            <h3>üì∂ Adaptive Data Rate</h3>
                            <div id="adrStatus">
                                <p class="text-muted">Loading ADR status...</p>
                            </div>
                        </div>

                        <!-- Bluetooth Mesh Section -->
                        <div class="settings-section ble-section">
                            <h3>üì± Bluetooth Mesh</h3>
                            <p class="section-desc">Connect to nearby devices via Bluetooth Low Energy</p>

                            <div class="ble-status-row">
                                <div class="ble-status-indicator">
                                    <span id="bleStatus" class="ble-status disconnected">BLE Disconnected</span>
                                    <span id="bleDeviceName" class="ble-device-name">-</span>
                                </div>
                                <div id="bleAvailability" class="ble-availability"></div>
                            </div>

                            <div class="ble-actions">
                                <button id="bleConnectBtn" class="btn btn-primary" onclick="bleState.connected ? disconnectBLE() : connectBLE()">
                                    Connect BLE
                                </button>
                                <button class="btn btn-secondary" onclick="scanBLEPeers()">
                                    Scan for Peers
                                </button>
                            </div>

                            <div class="ble-peers-section">
                                <h4>Discovered BLE Peers</h4>
                                <div id="blePeersList">
                                    <p class="text-muted">No BLE peers discovered</p>
                                </div>
                            </div>

                            <!-- Relay Mode Section -->
                            <div class="ble-relay-section" id="bleRelaySection" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                                <h4>Mesh Relay Mode</h4>
                                <p class="text-muted small">Become a mesh node via BLE - receive and send LoRa mesh messages</p>

                                <div class="relay-status-row" style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                                    <span id="relayStatus" class="relay-status" style="padding: 4px 8px; border-radius: 4px; background: #333; font-size: 12px;">Relay Off</span>
                                    <span id="relayVirtualAddr" class="relay-addr" style="font-family: monospace; color: #888;"></span>
                                </div>

                                <div class="relay-actions" style="display: flex; gap: 10px; margin: 10px 0;">
                                    <button id="relayModeBtn" class="btn btn-secondary" onclick="toggleRelayMode()" disabled>
                                        Enable Relay Mode
                                    </button>
                                    <input type="text" id="relayClientName" placeholder="Client name" value="WebClient"
                                           style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #333; color: #fff; width: 120px;">
                                </div>
                            </div>

                            <div class="ble-info">
                                <strong>About BLE Mesh:</strong>
                                <ul>
                                    <li>Connect to phones/computers running LNK-22 app</li>
                                    <li>BLE preferred over LoRa when in range</li>
                                    <li>Messages auto-route via fastest path</li>
                                    <li>Relay Mode: Become a mesh node via BLE!</li>
                                    <li>Requires Chrome/Edge with Web Bluetooth</li>
                                </ul>
                            </div>
                        </div>

                        <!-- LAN Discovery Section -->
                        <div class="settings-section lan-section">
                            <h3>üåê LAN Discovery</h3>
                            <p class="section-desc">Connect to other web clients on the same network via WebRTC</p>

                            <div class="lan-status-row">
                                <div class="lan-status-indicator">
                                    <span id="lanStatus" class="lan-status disconnected">LAN Inactive</span>
                                    <span id="lanPeerCount" class="lan-peer-count">0</span>
                                    <span class="lan-label">peers</span>
                                </div>
                            </div>

                            <div class="lan-actions">
                                <button id="lanDiscoveryBtn" class="btn btn-primary" onclick="lanState.isDiscovering ? stopLANDiscovery() : startLANDiscovery()">
                                    Start Discovery
                                </button>
                            </div>

                            <div class="lan-peers-section">
                                <h4>LAN Peers</h4>
                                <div id="lanPeersList">
                                    <p class="text-muted">No LAN peers discovered</p>
                                </div>
                            </div>

                            <div class="lan-info">
                                <strong>How LAN Discovery Works:</strong>
                                <ul>
                                    <li>Web clients on the same network auto-discover each other</li>
                                    <li>Direct peer-to-peer connections via WebRTC</li>
                                    <li>Messages route through LAN first (fastest path)</li>
                                    <li>Falls back to radio when LAN unavailable</li>
                                </ul>
                                <p class="lan-server-note">
                                    <strong>Note:</strong> Requires a signaling server running on your network.
                                    <br><code>python3 signaling_server.py</code>
                                </p>
                            </div>
                        </div>

                        <!-- WAN Bridge Section -->
                        <div class="settings-section wan-section">
                            <h3>üåç WAN Bridge (Internet Trunk)</h3>
                            <p class="section-desc">Connect mesh networks across the internet via encrypted tunnels</p>

                            <div class="wan-status-row">
                                <div class="wan-status-indicator">
                                    <span id="wanStatus" class="wan-status disconnected">WAN Disconnected</span>
                                    <span id="wanSiteCount" class="wan-site-count">0</span>
                                    <span class="wan-label">remote sites</span>
                                </div>
                            </div>

                            <div class="wan-connect-form">
                                <div class="form-group">
                                    <label>Bridge Server URL</label>
                                    <input type="text" id="wanBridgeUrl" class="input" placeholder="wss://bridge.example.com:9000" value="ws://localhost:9000" />
                                </div>
                                <div class="wan-actions">
                                    <button id="wanConnectBtn" class="btn btn-primary" onclick="wanState.connected ? disconnectWANBridge() : connectWANBridge()">
                                        Connect WAN
                                    </button>
                                </div>
                            </div>

                            <div class="wan-sites-section">
                                <h4>Connected Sites</h4>
                                <div id="wanSitesList">
                                    <p class="text-muted">No remote sites connected</p>
                                </div>
                            </div>

                            <div class="wan-info">
                                <strong>About WAN Bridge:</strong>
                                <ul>
                                    <li>Connect multiple mesh networks across the internet</li>
                                    <li>Messages are relayed between sites automatically</li>
                                    <li>Use <code>wss://</code> for encrypted connections</li>
                                    <li>Host your own bridge or use a shared community server</li>
                                </ul>
                                <p class="wan-server-note">
                                    <strong>Run your own bridge:</strong>
                                    <br><code>python3 wan_bridge.py 9000</code>
                                </p>
                            </div>
                        </div>

                        <!-- Emergency SOS Section -->
                        <div class="settings-section emergency-section">
                            <h3>üö® Emergency SOS</h3>
                            <div id="sosStatus">
                                <p class="text-muted">Emergency SOS ready</p>
                            </div>
                            <button id="sosButton" class="btn btn-danger sos-button" onclick="activateSOS()">
                                üÜò EMERGENCY SOS
                            </button>
                            <small class="text-muted">Broadcasts your location and distress signal to all nodes</small>
                        </div>

                        <div class="settings-section">
                            <h3>üîß Network Configuration</h3>
                            <div class="form-group">
                                <label>Beacon Interval (seconds)</label>
                                <input type="number" class="input" value="30" min="10" max="300" />
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked />
                                    Enable GPS
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked />
                                    Auto-ACK Messages
                                </label>
                            </div>
                            <button class="btn btn-primary">Save Network Settings</button>
                        </div>

                        <div class="settings-section">
                            <h3>üé® Display Options</h3>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="darkMode" />
                                    Dark Mode
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked />
                                    Show Packet Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked />
                                    Animate Network Graph
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Refresh Interval (ms)</label>
                                <input type="number" class="input" value="1000" min="100" max="5000" step="100" />
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>‚ÑπÔ∏è About</h3>
                            <div class="about-info">
                                <p><strong>LNK-22 Mesh Network</strong></p>
                                <div id="versionInfo" class="version-info">
                                    <div class="version-row">
                                        <span>Web Client:</span> <code id="aboutVersion">1.8.0</code>
                                    </div>
                                    <div class="version-row">
                                        <span>Firmware:</span> <code id="aboutFirmware">Unknown</code>
                                    </div>
                                </div>
                                <hr/>
                                <p>RadioLib: 6.6.0</p>
                                <p>Protocol: AODV + DTN</p>
                                <p>Board: RAK4631</p>
                                <hr/>
                                <p><strong>Features (v1.8.0):</strong></p>
                                <ul class="feature-list">
                                    <li>‚úÖ Store-and-Forward Messaging</li>
                                    <li>‚úÖ Adaptive Data Rate (ADR)</li>
                                    <li>‚úÖ Emergency SOS Mode</li>
                                    <li>‚úÖ Message History</li>
                                    <li>‚úÖ Secure Links (X25519)</li>
                                    <li>‚úÖ DTN Bundle Protocol</li>
                                    <li>‚úÖ Geographic Routing (GPSR)</li>
                                    <li>‚úÖ Encrypted Group Channels</li>
                                    <li>‚úÖ Forward Secrecy (Double Ratchet)</li>
                                </ul>
                                <hr/>
                                <p class="text-muted">
                                    Professional LoRa mesh networking firmware with
                                    autonomous operation, multi-hop routing, and
                                    end-to-end encryption.
                                </p>
                                <button class="btn btn-secondary btn-block">View Documentation</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <script type="module" src="/src/main-enhanced.js?v=1.9.1"></script>
</body>
</html>
